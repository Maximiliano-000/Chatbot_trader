<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AnaliZ ‚Äì Relat√≥rio Premium</title>
  <style>
    body {
      font-family: "DejaVu Sans", sans-serif;
    }
  </style>  
  <meta name="theme-color" content="#ffffff" />
  <style>
    body {
      font-family: 'DejaVu Sans', sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f9f9f9;
      color: #111;
    }
    img {
      max-width: 100%;
      height: auto;
    }
    p {
      text-align: justify;
      text-indent: 1.5em;
    }
    .container {
      max-width: 850px;
      margin: auto;
      background: #fff;
      padding: 2.5rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .header-banner img {
      width: 100%;
      display: block;
      margin-bottom: 2rem;
    }
    h2, h3 {
      color: #003b50;
      margin-top: 2rem;
    }
    ul {
      padding-left: 1.5rem;
    }
    blockquote {
      background: #f1f1f1;
      border-left: 4px solid #00bcd4;
      padding: 1rem;
      margin-top: 2rem;
      font-style: italic;
      color: #444;
      text-align: justify;
    }
    .btns {
      margin-top: 2.5rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .btn {
      text-decoration: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-weight: 500;
      display: inline-block;
    }
    .btn-pdf { background: #003b50; color: white; }
    .btn-whatsapp { background: #25D366; color: white; }
    footer {
      text-align: center;
      font-size: 0.85rem;
      color: #555;
      margin-top: 3rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.6rem;
      border: 1px solid #ccc;
      text-align: left;
    }
    th {
      background-color: #e6f4f6;
    }
    #sumario ul {
      margin-left: 1.2rem;
      margin-top: 0;
    }
    #sumario a {
      color: #003b50;
      text-decoration: none;
    }
    .placeholder {
      color: #666;
      font-style: italic;
      background: #f0f0f0;
      padding: 0.6rem;
      border-left: 4px solid #bbb;
      border-radius: 4px;
    }
    small {
      display: block;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #666;
      text-align: center;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-banner">
      <img src="{{ url_for('static', filename='logo_banner.png') }}" alt="AnaliZ Banner" />
    </div>

    {% if session['usuario'] %}
      <p style="text-align: right; font-size: 0.85rem; color: #444;">
        Usu√°rio: <strong>{{ session['usuario']['id'] }}</strong> |
        Cr√©ditos restantes: <strong>{{ session['usuario']['creditos'] }}</strong>
      </p>
    {% endif %}

    <h2><strong>An√°lise T√©cnica Premium para {{ ticker }}</strong></h2>
    <p style="font-size: 0.95rem; font-style: italic; color: #444;">
      Gerado automaticamente em {{ datahora }}, com base em dados t√©cnicos.
    </p>

    <h3 id="sumario">Sum√°rio</h3>
    <ul>
      <li><a href="#indicadores">1. Indicadores T√©cnicos</a></li>
      <li><a href="#ia">2. Interpreta√ß√£o da IA</a></li>
      <li><a href="#grafico">3. Gr√°fico T√©cnico</a></li>
      <li><a href="#cenario">4. Cen√°rios Alternativos</a></li>
      <li><a href="#historico">5. Hist√≥rico de Previs√µes</a></li>
      <li><a href="#conclusao">6. Considera√ß√µes Finais</a></li>
    </ul>

    <h2 id="indicadores">1. Indicadores T√©cnicos</h2>
    <ul>
      <li><strong>RSI</strong>: {{ rsi }}</li>
      <li><strong>SMA 20 dias</strong>: R$ {{ sma20 }}</li>
      <li><strong>SMA 50 dias</strong>: R$ {{ sma50 }}</li>
      <li><strong>Bollinger</strong>: Sup = R$ {{ upper_band }} / Inf = R$ {{ lower_band }}</li>
      <li><strong>Volume M√©dio</strong>: {{ volume_medio }}</li>
    </ul>

    {% if session['aviso_sma20'] %}
    <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; border-radius: 8px;">
      ‚ö†Ô∏è {{ session['aviso_sma20'] }}
    </div>
    {% endif %}

    <h2 id="ia">2. Interpreta√ß√£o da IA</h2>

    {% if ia_falhou %}
    <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border-left: 4px solid #ffc107; color: #856404;">
      ‚ö†Ô∏è <strong>Nota:</strong> A IA n√£o conseguiu gerar uma resposta completa neste momento.<br><br>
      Isso pode acontecer ocasionalmente por instabilidade da API.

      {% if modo != 'pdf' %}
      <div style="margin-top: 1rem;">
        <a href="/relatorio?ticker={{ ticker }}" class="btn btn-pdf">üîÅ Gerar novamente</a>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <h3>Indicadores T√©cnicos</h3>
    <p>{% if analise.indicadores.strip() %}{{ analise.indicadores }}{% else %}<span class="placeholder">Informa√ß√£o n√£o dispon√≠vel no momento.</span>{% endif %}</p>

    {% if insights_tecnicos %}
    <div style="margin-top: 2rem; padding: 1.5rem; background-color: #202020; border-left: 4px solid #6c63ff; border-radius: 12px;">
      <h3 style="color: #fff; font-size: 1.2rem;">üîé O que os indicadores est√£o dizendo?</h3>
      <ul style="color: #ccc; font-size: 0.95rem; line-height: 1.6; list-style: none; padding-left: 0;">
        {% for insight in insights_tecnicos %}
          <li style="margin-bottom: 10px;">
            {% if "RSI" in insight %}
              <span style="display: inline-block;">üîç {{ insight | safe }}</span><br>
              <small style="color: #999;">üìå Sugest√£o: Zona de poss√≠vel entrada ‚Äî mas √© recomend√°vel acompanhar de perto antes de agir.</small>
            {% elif "banda inferior" in insight %}
              <span style="display: inline-block;">üß≠ {{ insight | safe }}</span><br>
              <small style="color: #999;">üìå Sugest√£o: Ponto de observa√ß√£o t√©cnico. Valide com outros indicadores e volume.</small>
            {% elif "banda superior" in insight %}
              <span style="display: inline-block;">üìâ {{ insight | safe }}</span><br>
              <small style="color: #999;">üìå Sugest√£o: Momento de aten√ß√£o. Pode haver revers√£o em breve.</small>
            {% elif "m√©dia de 20 dias" in insight %}
              <span style="display: inline-block;">üìà {{ insight | safe }}</span><br>
              <small style="color: #999;">üìå Sugest√£o: Acompanhar de perto para entender se a tend√™ncia atual vai se confirmar ou reverter.</small>
            {% else %}
              <span style="display: inline-block;">üìå {{ insight | safe }}</span>
            {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

    <h3>Tend√™ncia Atual</h3>
    <p>{% if analise.tendencia.strip() %}{{ analise.tendencia }}{% else %}<span class="placeholder">Informa√ß√£o n√£o dispon√≠vel no momento.</span>{% endif %}</p>

    <!-- >>> In√≠cio da se√ß√£o Prophet ‚Äì previs√£o t√©cnica com IA -->
<section class="previsao-prophet" style="margin-top: 40px; padding: 20px; background-color: #121212; border-left: 4px solid #e50914; border-radius: 12px;">
  <h2 style="color: #fff; font-weight: 600;">Previs√£o de Tend√™ncia (Prophet)</h2>

  <p style="color: #ddd; font-size: 1.05em;">
    Para o per√≠odo selecionado, o modelo Prophet identificou um
    <strong style="color: #ff5252;">vi√©s de {{ vi√©s_tend√™ncia }}</strong>.
    A expectativa √© que o ativo oscile entre <strong>R$ {{ limite_minimo }}</strong> e
    <strong>R$ {{ limite_maximo }}</strong>, com base nos ajustes t√©cnicos aplicados a partir das
    Bandas de Bollinger.
  </p>

  <p style="color: #ccc; font-size: 0.95em; line-height: 1.6;">
    {{ mensagem_prophet | safe }}
  </p>  

  {% if ajuste_prophet %}
  <div style="background-color: #1e1e1e; border-left: 4px solid #ffa500; padding: 12px; margin-top: 15px; border-radius: 8px;">
    <p style="color: #f1c40f; font-size: 0.9em;">
      A previs√£o foi suavizada e mantida dentro de limites t√©cnicos com base em indicadores recentes do ativo. Isso garante maior ader√™ncia ao comportamento real do mercado.
    </p>
  </div>
  {% endif %}

  {% if alerta_estabilidade %}
  <div style="background-color: #182c1a; border-left: 4px solid #27ae60; padding: 12px; margin-top: 12px; border-radius: 8px;">
    <p style="color: #2ecc71; font-size: 0.9em;">
      Observou-se uma faixa de oscila√ß√£o estreita. O mercado pode estar em fase de consolida√ß√£o.
    </p>
  </div>
  {% endif %}

  {% if aviso_sma20 %}
  <p style="color: #999; font-size: 0.85em; margin-top: 10px;">‚ö†Ô∏è {{ aviso_sma20 }}</p>
  {% endif %}
</section>        

    <h3>Cen√°rio Projetado</h3>
    <p>{% if analise.previsao.strip() %}{{ analise.previsao }}{% else %}<span class="placeholder">Informa√ß√£o n√£o dispon√≠vel no momento.</span>{% endif %}</p>

    <div style="padding: 16px; background-color: #121212; border-radius: 12px; color: #eee; font-family: 'Arial', sans-serif; margin-top: 24px;">
      <h3 style="color: #ff4d4d;">An√°lise Inteligente da Previs√£o (IA + T√©cnicos)</h3>
    
      <p>
        As previs√µes dos pr√≥ximos <strong>{{ dias }}</strong> dias foram ajustadas com base em limites t√©cnicos realistas:
      </p>
    
      <ul>
        <li><strong>Limite superior (resist√™ncia t√©cnica):</strong> R$ {{ limite_maximo }}</li>
        <li><strong>Limite inferior (suporte t√©cnico):</strong> R$ {{ limite_minimo }}</li>
      </ul>
    
      {% if alerta_estabilidade %}
      <p style="color: #f4c542;">
        <strong>‚ö†Ô∏è Observa√ß√£o:</strong> A amplitude entre suporte e resist√™ncia √© estreita, sugerindo prov√°vel fase de lateraliza√ß√£o do ativo.
      </p>
      {% endif %}
    
      {% if ajuste_prophet %}
      <p style="color: #ff9999;">
        <strong>üîç Ajuste aplicado:</strong> O modelo Prophet foi automaticamente limitado para evitar distor√ß√µes estat√≠sticas nos extremos da previs√£o.
      </p>
      {% endif %}
    
      <p>
        Esses ajustes tornam a previs√£o mais confi√°vel e alinhada com o comportamento real do mercado.
        Relat√≥rios premium AnaliZ integram intelig√™ncia t√©cnica e leitura contextual para apoiar decis√µes mais conscientes.
      </p>
    </div>    

    {% if ajuste_lstm %}
    <div style="margin-top: 1rem; padding: 1rem; border-left: 4px solid #ff9800; background: #fff8e1; color: #5f370e;">
      ‚ö†Ô∏è <strong>Nota t√©cnica:</strong> A previs√£o LSTM foi ajustada automaticamente com base na m√©dia m√≥vel (SMA20 ¬± 15%) para manter coer√™ncia com os padr√µes t√©cnicos recentes.
    </div>
    {% endif %}

    <h3>Estrat√©gia</h3>
    <p>{% if analise.estrategia.strip() %}{{ analise.estrategia }}{% else %}<span class="placeholder">Nenhuma estrat√©gia sugerida foi gerada.</span>{% endif %}</p>

    <h3>Gest√£o de Risco</h3>
    <p>Stop: R$ {{ stop }} | Alvo: R$ {{ alvo }}</p>

    <h2 id="grafico">3. Gr√°fico T√©cnico ‚Äì Evolu√ß√£o e Indicadores</h2>
    <div style="margin: 2rem 0; text-align: center; max-width: 100%;">
      {{ grafico | safe }}

      <small style="display: block; color: #aaa; margin-top: 0.5rem;">
        Gr√°fico gerado automaticamente com base em indicadores t√©cnicos via matplotlib.
      </small>

      <!-- ‚úÖ Legenda visual dos marcadores -->
      <small style="display: block; color: #bbb; margin-top: 0.4rem;">
        üî∫ RSI extremo | üü° Cruzamento altista | ‚ö™ Cruzamento baixista | ‚¨õ Rompimento superior | ‚ùå Rompimento inferior | ‚îÜ Changepoint
      </small>

    <div style="margin-top: 10px; background-color: #1a1a1a; padding: 10px 15px; border-left: 4px solid #777; border-radius: 8px; display: inline-block; text-align: left;">
      <p style="color: #ccc; font-size: 0.9em; margin: 0;">
        üîç <strong>Changepoints:</strong> As linhas verticais tracejadas em cinza representam momentos em que o modelo Prophet identificou mudan√ßas relevantes na trajet√≥ria do ativo. Essas marca√ß√µes tornam a previs√£o mais sens√≠vel a inflex√µes reais do mercado.
      </p>
    </div>

  <p style="color: #f55; font-size: 0.95em; margin-top: 1.2rem; max-width: 680px; margin-left: auto; margin-right: auto; text-align: left;">
    <strong>O que s√£o changepoints?</strong> S√£o pontos identificados automaticamente pelo modelo Prophet, onde o comportamento do mercado muda de maneira significativa. Isso permite que o modelo ajuste sua previs√£o de forma mais fiel √† realidade do ativo.
  </p>
</div>

    <h2 id="cenario">4. Cen√°rios Alternativos</h2>
    <div>
      {{ cenarios | safe }}
    </div>

    <h2 id="lstm">5. Previs√£o com LSTM (IA Avan√ßada)</h2>

    {% if previsoes_lstm %}
      <p>
        Abaixo, apresentamos a previs√£o de pre√ßos para os pr√≥ximos <strong>{{ dias }}</strong> dias,
        gerada por uma rede neural do tipo <strong>LSTM</strong> (Long Short-Term Memory), treinada com dados do ativo <strong>{{ ticker }}</strong>.
      </p>
      <div class="card">
        <ul>
          {% for valor in previsoes_lstm %}
            <li>Dia {{ loop.index }}: R$ {{ valor | round(2) }}</li>
          {% endfor %}
          </ul>
          </div>

          {% if session.get('lstm_credito_usado') %}
          <div style="margin-top: 1rem; padding: 1rem; background: #e8f5e9; border-left: 4px solid #43a047; color: #2e7d32; border-radius: 8px;">
            ‚úÖ Um cr√©dito foi utilizado para gerar esta previs√£o com IA Avan√ßada (LSTM).
          </div>
          {% endif %}

    {% else %}
      <div class="card">
        <p style="color: #888; font-style: italic;">
          üîì Previs√£o com rede neural LSTM dispon√≠vel como recurso premium.<br>
          <small>Adquira com 1 cr√©dito ou ative o plano <strong>Carteira Pro</strong> para desbloquear esta an√°lise.</small>
        </p>

        {% if modo != "pdf" %}
        <div style="margin-top: 1rem;">
          <a href="/turbinar_lstm?ticker={{ ticker }}" class="btn btn-pdf">
            ‚ö° Turbinar com IA Avan√ßada (LSTM)
          </a>
        </div>
        {% endif %}
      </div>
    {% endif %}  
    
    {% if visao_leiga %}
    <div style="margin-top: 2rem; padding: 1rem 1.5rem; background-color: #181818; border-left: 4px solid #e50914; border-radius: 10px;">
      <h3 style="color: #fff; font-size: 1.2rem;">ü§ñ Vis√£o da IA em palavras simples</h3>
      <p style="color: #ccc; font-size: 0.95rem; line-height: 1.5;">{{ visao_leiga }}</p>
    </div>
    {% endif %}
    
    <h2 id="conclusao">6. Considera√ß√µes Finais</h2>
    <p>{{ conclusao_final }}</p>
    </p>

    <blockquote>{{ aviso }}</blockquote>

    {% if modo != "pdf" %}
    <div class="btns">
      <a class="btn btn-pdf" href="/exportar_pdf?ticker={{ ticker }}" target="_blank">Baixar PDF</a>
      <a class="btn btn-whatsapp" href="https://wa.me/?text=Confira%20essa%20an√°lise%20premium%20de%20{{ ticker }}%20no%20AnaliZ" target="_blank">Compartilhar no WhatsApp</a>
    </div>
    {% endif %}

    <footer>
      Gerado por <strong>AnaliZ</strong><br />
      √öltima atualiza√ß√£o: {{ datahora }}<br />
      <span style="font-size: 0.85rem;">¬© 2025 Wesley Maximiliano Braga. Todos os direitos reservados.</span>
    </footer>    
  </div>
</body>
</html>